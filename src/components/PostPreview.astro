---
import IconChevronsRight from '~/icons/chevrons-right.svg'
import type { CollectionEntry } from 'astro:content'
import { render } from 'astro:content'
import { Image } from 'astro:assets'
import type { ImageMetadata } from 'astro'
import Tags from '~/components/Tags.astro'
import PostInfo from '~/components/PostInfo.astro'
import type { Collation } from '~/types'
import { TagsGroup } from '~/utils'

const coverImageFiles = import.meta.glob<{ default: ImageMetadata }>(
  '~/content/posts/**/cover.png',
  { eager: true },
)

const fallbackCoverImages = Object.entries(coverImageFiles).reduce(
  (acc, [path, mod]) => {
    const normalizedPath = path.replace(/\\/g, '/')
    const match = normalizedPath.match(/content\/posts\/(.+)\/cover\.png$/)
    if (match) {
      acc[match[1]] = mod.default
    }
    return acc
  },
  {} as Record<string, ImageMetadata>,
)

interface Props {
  post: CollectionEntry<'posts'>
}

const { post } = Astro.props

const { remarkPluginFrontmatter } = await render(post)
const description = remarkPluginFrontmatter.description || post.data.description
let tags: Collation<'posts'>[] | undefined
if (post.data.tags && post.data.tags.length > 0) {
  const tagsGroup = await TagsGroup.build()
  tags = tagsGroup.matchMany(post.data.tags)
}
const samePage = Astro.url.pathname === `/posts/${post.id}`
const articleLink = samePage ? `#${post.id}` : `/posts/${post.id}`
const fallbackCoverImageFile =
  fallbackCoverImages[post.id] || fallbackCoverImages[post.slug]
const coverImage =
  post.data.coverImage ||
  (fallbackCoverImageFile
    ? { src: fallbackCoverImageFile, alt: `Cover image for ${post.data.title}` }
    : undefined)
---

<article class="w-full py-5 my-1 md:my-4 border-accent/10">
  <div
    class={`flex flex-col gap-5 ${coverImage ? 'md:flex-row md:items-start md:gap-6' : ''}`}
  >
    {
      coverImage && (
        <a href={articleLink} class="block md:max-w-[200px] w-full shrink-0">
          <Image
            src={coverImage.src}
            alt={coverImage.alt}
            width={480}
            loading="lazy"
            decoding="async"
            class="block rounded-xl w-full"
          />
        </a>
      )
    }
    <div class="flex-1">
      <h1 class="mb-3 text-2xl text-heading1 font-semibold">
        <a href={articleLink}>{post.data.title}</a>
      </h1>
      <PostInfo post={post} class="mb-3 mt-4" />
      {
        description && (
          <p class="pl-0.5 my-4 text-base/7 text-foreground">{description}</p>
        )
      }
      {
        tags && (
          <div class="mb-6">
            <Tags tags={tags} />
          </div>
        )
      }
      <div>
        <a class="button flex items-center !pl-3.5" href={articleLink}>
          {samePage ? 'Continue' : 'Read'}
          <IconChevronsRight class="size-5 ml-2" />
        </a>
      </div>
    </div>
  </div>
</article>
